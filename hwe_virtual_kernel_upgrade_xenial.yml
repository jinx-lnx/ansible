---
## Author: Ben Barrows
## bbarrows@getwellnetwork.com
## Tested only on Ansible 2.2.0.0

- name: Install Latest HWE Stack on VIRTUAL Ubuntu 14.04 (trusty) server
# If not hardcoding host here, add --extra-vars"=hosts=host.sub.tld"
# quotes included, on the command line and uncomment next line; else uncomment single host line below
#  hosts: '{{ hosts }}'
#  hosts: vls2.bwo.gwn
  user: root

  tasks:
    - name: Install linux-virtual-lts-xenial package
      apt:
        name: linux-virtual-lts-xenial
        state: latest
        install_recommends: yes
        update_cache: yes
        cache_valid_time: 3600
      when:
        - ansible_form_factor == 'Other'
        - ansible_distribution_release == 'trusty'
        - ansible_distribution_version == '14.04'
      register: kernel_upgrade

    - name: apt dist-upgrade
      apt:     
        upgrade: dist
      when:
        - ansible_form_factor == 'Other'
        - ansible_distribution_release == 'trusty'
        - ansible_distribution_version == '14.04'
      register: apt_distupgrade

# Ansible BUG 4029 - package name apparently required to use this module option
# This method will be broken until fixed upstream - shell workaround method below this block
#    - name: apt autoremove
#      apt:
#        autoremove: yes
#      when:
#        - ansible_form_factor == 'Other'
#        - ansible_distribution_release == 'trusty'
#        - ansible_distribution_version == '14.04'
#      register: apt_autoremove

    - name: apt autoremove
      shell: apt-get -y autoremove --purge
      when:
        - ansible_form_factor == 'Other'
        - ansible_distribution_release == 'trusty'
        - ansible_distribution_version == '14.04'
      register: apt_autoremove

    - name: reboot server
      command: reboot "Kernel Updates Triggered, reboot required!"
      async: 0
      poll: 0
      ignore_errors: true
      when:
        - ansible_form_factor == 'Other'
        - ansible_distribution_release == 'trusty'
        - ansible_distribution_version == '14.04'
        - kernel_upgrade|changed

#    - name: waiting for server to come back
#      connection: local
#      wait_for:
#        delay: 180
#        host: "{{ inventory_hostname }}"
#        port: 22
#        state: started
#      when:
#        - ansible_form_factor == 'Other'
#        - ansible_distribution_release == 'trusty'
#        - ansible_distribution_version == '14.04'
#        - kernel_upgrade|changed
